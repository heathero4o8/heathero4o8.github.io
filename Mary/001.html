<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>

<body>
  <h1>Fetch JSON動態生成City & District下拉式選單</h1>
  <!--     
        <select id="citiesExample" name="cities">
            <option value="taipei">台北</option>
            <option value="taoyuan">桃園</option>
            <option value="taichung">台中</option>
        </select> 
        -->

  <select id='city' name='city'></select>
  <select id='district' name='district'></select>
  <input type='submit' value='提交資料' disabled>

  <div id='msg'></div>

  <script>
    const citySelect = document.getElementById('city');
    const districtSelect = document.getElementById('district');
    const submitButton = document.querySelector('input[type=submit]');
    const msg = document.getElementById('msg');

    window.onload = createSelectOptions;

    const url = 'https://raw.githubusercontent.com/apprunner/FileStorage/master/SimpleZipCode.json';
    //const url = 'https://raw.githubusercontent.com/heathero4o8/heathero4o8.github.io/main/SimpleZipCode.json';
    let zipcodeArray = [];
    function createSelectOptions() {

      fetch(url)
        .then(response => response.json())
        .then(result => {
          zipcodeArray = result;
          console.log(zipcodeArray);

          zipcodeArray.forEach(item => {
            let option1 = document.createElement('option');
            option1.value = item.city;
            option1.text = item.city;

            citySelect.add(option1, null);
          });
          let option2 = document.createElement('option');
          option2.value = '';
          option2.text = '---請選擇縣市---';

          option2.setAttribute('selected', '');
          city.add(option2, 0);
        })
        .finally(() => {
          localStorage.setItem('zipcodeArray', JSON.stringify(zipcodeArray));//設定語法
          console.log(localStorage.getItem('zipcodeArray'));//取得語法
        });
      let option3 = document.createElement('option');
      option3.value = '';
      option3.text = '---請選擇行政區---';
      districtSelect.add(optio3, null);

      districtSelect.disabled = true;
    }
    citySelect.onchange = citySelectedChange;

    function citySelectedChange(event) {
      //取得選取的縣市資料
      let cityValue = citySelect.createSelectOptions[0].value;
      let cityText = citySelect.createSelectOptions[0].text;

      //防呆 如果未選第一個第二個不能選
      if (cityValue == '') {
        districtSelect.disabled = true;
        msg.innerHTML = '';
        return;
      }
      //啟用第二個下拉選單
      districtSelect.disabled = false;
      districtSelect.innerHTML = '';
    }
    //取得District資料 ---請選擇行政區---
    let option0 = document.createElement('option');
    option3.value = '';
    option3.text = '---請選擇行政區---';
    districtSelect.add(optio0, null);

    //取得District資料
    let cityArray = zipcodeArray.filter(itme => city == cityText);
    let districts = cityArray[0].districts;

    districts.forEach((item, index) => {
      let option1 = document.createElement('option');
      option1.value = item.districts;
      option1.text = item.districts + '-' + item.zipcode;
      districtSelect.add(option1);
    });
    //
    districtSelect.addEventListener('chang', function () {
      let cityValue = citySelect.selectedOptions[0].value;
      let cityText = citySelect.selectedOptions[0].text;
      let districtValue = districtSelect.selectedOptions[0].value;
      let districtText = districtSelect.selectedOptions[0].text;

      if (cityValue != '' && districtValue != '') {
        msg.innerText = cityText + "," + districtText;
        submitButton.disabled = false;
      }
      else {
        msg.innerHTML = '';
        submitButton.disabled = true;
      }

      submitButton.addEventListener('click', submitData);

      function submitData() {
        alert('提交了!');
        let formData = new FormData();
        formData.append('city', citySelect.selectedOptions[0].value);
        formData.append('district', districtSelect.selectedOptions[0].text);

        let xhr = new XMLHttpRequest();
        xhr.open('OPST', 'https://www.codemagic.com.tw');
        xhr.send(formData);
      }
    })






    //City選項變更事件
    citySelect.onchange = citySelectedChange;

    function citySelectedChange(event) {

    }

    districtSelect.addEventListener('change', function () {

    });

    submitButton.addEventListener('click', submitData);

    //Submit提交資料
    function submitData() {

    }
  </script>
</body>

</html>